<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hd.api.dao.SystemMessageMapper">
  <resultMap id="BaseResultMap" type="SystemMessage">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <constructor>
      <idArg column="SystemMessageId" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="Type" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="CreateTime" javaType="java.util.Date" jdbcType="TIMESTAMP" />
      <arg column="ToUserId" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="Status" javaType="java.lang.Integer" jdbcType="INTEGER" />
      <arg column="Category" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="FromUserId" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="Remark" javaType="java.lang.String" jdbcType="NVARCHAR" />
    </constructor>
  </resultMap>
  <resultMap id="ResultMapWithBLOBs" type="SystemMessage">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <constructor>
      <idArg column="SystemMessageId" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="Type" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="CreateTime" javaType="java.util.Date" jdbcType="TIMESTAMP" />
      <arg column="ToUserId" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="Status" javaType="java.lang.Integer" jdbcType="INTEGER" />
      <arg column="Category" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="FromUserId" javaType="java.lang.String" jdbcType="CHAR" />
      <arg column="Remark" javaType="java.lang.String" jdbcType="NVARCHAR" />
      <arg column="Message" javaType="java.lang.String" jdbcType="LONGNVARCHAR" />
    </constructor>
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    SystemMessageId, Type, CreateTime, ToUserId, Status, Category, FromUserId, Remark
  </sql>
  <sql id="Blob_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    Message
  </sql>
  
  <!-- 自定义 -->
  <select id="getHomeSysMessage" resultType="HomeSysMessageDTO">
	SELECT  SUM(t.Counts) Counts, Category
	FROM    (SELECT COUNT(Category) Counts, Category
	         FROM   SystemMessage s
	         WHERE  s.ToUserId = #{userid}
	                AND s.Status = 1
	         GROUP BY s.Category
	         UNION ALL
	         SELECT COUNT(1) Counts, 'D' Category
	         FROM   ChatMessage
	         WHERE  ToUserId = #{userid}
	                AND ReadStatus = '0'
	        ) t
	GROUP BY t.Category
	having SUM(t.Counts)>0
  </select>
  
  <select id="getNewSysMessage" resultType="HomeSysMessageDTO">
	SELECT TOP 1
	        Message NewMessage,
	        CAST(DATEDIFF(s, '1970-01-01 08:00:00', CreateTime) AS VARCHAR(20)) SendTime
	FROM    SystemMessage ss
	WHERE   Category = #{category}
	        AND ss.ToUserId = #{userid}
	ORDER BY ss.CreateTime DESC
  </select>
  
  <select id="listLatelySysMessage" resultType="HomeSysMessageDTO">
	SELECT  *
	FROM    ( SELECT    Category ,
	                    Message NewMessage,
	                    CAST(DATEDIFF(s, '1970-01-01 08:00:00', CreateTime) AS VARCHAR(20)) SendTime,
	                    ROW_NUMBER() OVER ( PARTITION BY Category ORDER BY CreateTime DESC ) NewIndex
	          FROM      SystemMessage
	          WHERE     ToUserId = #{userid}
	        ) t
	WHERE   t.NewIndex = 1
  </select>
  
  <select id="getPushMessages" resultType="Systemmessage">
	SELECT *
	FROM    SystemMessage ss
	WHERE   ss.Status = 0
	ORDER BY ss.CreateTime
  </select>
 
  <select id="getNewFriendMessage" parameterType="java.lang.String" resultType="hashmap">
	SELECT  ROW_NUMBER() OVER (PARTITION BY c.FromUserId ORDER BY c.CreateTime DESC) num,
	        c.*, u.UserName, u.AvatarUrl
	INTO    #NewChat
	FROM    ChatMessage c
	LEFT JOIN UserInfo u ON c.FromUserId = u.UserId
	WHERE   c.ReadStatus = '0'
	        AND c.ToUserId = #{userid}
	
	SELECT  s.SystemMessageId, s.Message, s.Type, u.UserId, u.UserName,
	        u.AvatarUrl,
	        CAST(DATEDIFF(s, '1970-01-01 08:00:00', s.CreateTime) AS VARCHAR(20)) CreateTime,
	        1 Counts
	FROM    SystemMessage s
	LEFT JOIN UserInfo u ON s.FromUserId = u.UserId
	WHERE   s.Status = 1
	        AND s.ToUserId = #{userid}
	        AND s.Category = 'D'
	UNION ALL
	SELECT  ChatMessageId SystemMessageId, Message, 'A' Type, FromUserId UserId,
	        UserName, AvatarUrl,
	        CAST(DATEDIFF(s, '1970-01-01 08:00:00', CreateTime) AS VARCHAR(20)) CreateTime,
	        (SELECT COUNT(1)
	         FROM   #NewChat
	        ) Counts
	FROM    #NewChat
	WHERE   num = 1
	ORDER BY CreateTime DESC
  </select>
  
  <update id="updateUnReadMessage">
  	UPDATE  SystemMessage
	SET     Status = 2
	WHERE   Status = 1
	        AND ToUserId = #{userid}
	<foreach collection="categorys" item="category" >
		AND Category = #{category}
	</foreach>       
  </update>
  
  <select id="getSysMessageInfo" resultType="com.hd.api.dto.SystemMessageDTO">
	SELECT  SystemMessageId ,
	        Message ,
	        CAST(DATEDIFF(s, '1970-01-01 08:00:00', CreateTime) AS VARCHAR(20)) CreateTime
	FROM    SystemMessage
	WHERE   Status >= 1
	        AND ToUserId = #{userid}
	        AND Category = #{category}
	ORDER BY CreateTime DESC 
  </select>
  
</mapper>






